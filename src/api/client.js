import axios from 'axios';

// –ë–∞–∑–æ–≤—ã–π URL –±—ç–∫–µ–Ω–¥–∞
const BASE_URL = process.env.REACT_APP_API_URL || 'http://localhost:5000/api';

// DEBUG: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫–æ–π URL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
console.log('üîó API URL:', BASE_URL);
console.log('üîß REACT_APP_API_URL:', process.env.REACT_APP_API_URL);

// –°–æ–∑–¥–∞–Ω–∏–µ axios instance
const apiClient = axios.create({
  baseURL: BASE_URL,
  headers: {
    'Content-Type': 'application/json',
  },
  timeout: 10000, // 10 —Å–µ–∫—É–Ω–¥
});

// Interceptor –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è JWT —Ç–æ–∫–µ–Ω–∞ –∫ –∑–∞–ø—Ä–æ—Å–∞–º
apiClient.interceptors.request.use(
  (config) => {
    const token = localStorage.getItem('jwt_token');
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// Interceptor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω - –≤—ã—Ö–æ–¥ –∏–∑ –∞–¥–º–∏–Ω–∫–∏
      localStorage.removeItem('jwt_token');
      localStorage.removeItem('admin_user');

      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–∞ –∞–¥–º–∏–Ω—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
      if (window.location.pathname.startsWith('/admin') && window.location.pathname !== '/admin/login') {
        window.location.href = '/admin/login';
      }
    }
    return Promise.reject(error);
  }
);

export default apiClient;
